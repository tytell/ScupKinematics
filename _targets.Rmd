---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

# Setup

Remove the `_targets_r` directory previously written by non-interactive runs of the report. Otherwise, the pipeline may contain superfluous targets.

```{r unscript}
library(targets)
library(tarchetypes)
tar_unscript()
```

# Globals

Run Matlab from the command line using this command:
```
% matlab -nodesktop -nosplash -useStartupFolderPref -r MatlabServer
```

```{targets packages-global, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
tar_option_set(packages = c("tidyverse", "R.matlab", "here", "tarchetypes"))

rawdatapath <- "/Volumes/Data/WHOI-2022/Data from Erik Anderson/TE_WHOI_2022_bottomview"
processeddatapath <- "processed_data"

source("code/matlab_commands.R")
```

```{targets matlab-global, tar_globals = TRUE}
matlab <- R.matlab::Matlab()

if (!open(matlab)) {
  cli::cli_alert_danger("Could not connect to MATLAB server")
  throw("Could not connect to MATLAB server")
}
cli::cli_alert_info("Connected to MATLAB: {matlab}")
```

# Targets

```#{targets calibration}
list(
  tar_target(calib_images_file, 
             command = "raw_data/calibration2022_06_16_files.csv", 
             format = "file")
  tar_target(calib_images,
             read_csv(calib_images_file))
  tar_target(calibfile,
             command = calibrate_bottomview(file.path(rawdatapath, "calibrations"),
                                            calib_images$right_images,
                                            calib_images$left_images,
                                            calib_images$square_size_mm[[1]],
                                            here("processed_data", 
                                                 "TE_WHOI_2022_bottomview", 
                                                 "calibrations", 
                                                 "TE_06_16_2022_1655_calibration.mat")),
             format = "file"))
)
```

```{targets calibration}
tarchetypes::tar_plan(
  calib_images_file = "raw_data/calibration2022_06_16_files.csv", 
  calib_images = read_csv(calib_images_file),
  calibfile = calibrate_bottomview(rawdatapath,
                                   calib_images$right_images,
                                   calib_images$left_images,
                                   calib_images$square_size_mm[[1]],
                                   here("processed_data", 
                                        "TE_WHOI_2022_bottomview", 
                                        "calibrations", 
                                        "TE_06_16_2022_1655_calibration.mat"))
)
```

# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r tar_make}
tar_make()
```

# Output

The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r tar_visnetwork}
tar_visnetwork()
```

At this point, you can go back and run `{targets}` chunks in interactive mode without interfering with the code or data of the non-interactive pipeline.
