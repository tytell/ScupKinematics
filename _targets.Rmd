---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

```{r}
library(targets)
library(tarchetypes)
library(tidyverse)
library(here)
```

# Setup

This removes the auto-generated `_targets.R` file.

```{r}
tar_unscript()
```

# Globals

We first define some global options/functions common to all targets. 

```{targets global-paths, tar_globals = TRUE}
library(tarchetypes)

options(tidyverse.quiet = TRUE)
tar_option_set(packages = c("tidyverse", "here", "R.utils"),
               workspace_on_error = TRUE, # Save a workspace file for a target that errors out.
               format = "parquet"
)
tar_resources_parquet(compression = "snappy")

if (.Platform$OS.type == "unix") {
  videodatapath <- "/Volumes/Data/WHOI-2022/Data from Erik Anderson/TE_WHOI_2022_bottomview/experiments"
  datarootpath <- "/Volumes/DataSync/ScupKinematics/processed_data/experiments"
} else {
  videodatapath <- "Z:\\WHOI-2022\\Data from Erik Anderson\\TE_WHOI_2022_bottomview\\experiments"
  datarootpath <- "Y:\\ScupKinematics\\processed_data\\experiments"
}
#videodatapath <- "/Users/etytel01/Documents/2023/ScupKinematics-old/raw_data/TE_WHOI_2022_bottomview/experiments"
rawdatapath <- "raw_data"
processeddatapath <- "processed_data"

nfilesingroup <- 5
```

```{targets functions, tar_globals = TRUE}
source("code/scan_raw_files.R")
source("code/midlines.R")
```

# Targets

Matlab script that runs the calibration and generates the `.mat` file that has
the calibration parameters.
```{targets calibration}
list(
  tar_file(calibration_m, here("code", "bottomview_06_16_2022_calib.m")),
  tar_target(calibration, 
             prompt_run_matlab(calibration_m,
                               here("processed_data", 
                                    "TE_WHOI_2022_bottomview/calibrations",
                                    "TE_06_16_2022_1655_calibration.mat")),
             format = "file")
)
```

```{targets triangulate}
list(
  tar_file(filelist, scan_bottomview_files(videodatapath, 
                                         here(processeddatapath, "all_bottomview_files.csv"))),
  tar_file(triangulate_m, "code/triangulate_all_bottomview_data.m"),
  tar_target(data3d, 
             check_matlab_processing(triangulate_m,
                               here(processeddatapath, "processed_bottomview_files.csv"),
                               filelist, calibration),
             format = "file")
)
```

```{targets read_file, tar_globals = TRUE}
read_data_file <- function(datarootpath, filename)
{
  cli::cli_alert_info("Read file {basename(filename)}")
  
  df <- read_csv(file.path(datarootpath, filename), id = "filename",
           col_types = list(.default = col_double()),
           show_col_types = FALSE) |> 
    reorganize_outline_data() |> 
    mutate(filename = factor(filename))
  cli::cli_alert_info("  {nrow(df)} row{?s}")
  df
}
```

```{targets even_outline, tar_globals = TRUE}
even_outline_spacing <- function(df)
{
    df |> 
    ungroup() |> 
    mutate(swimdir =
             purrr::map(outline, \(df) get_central_axis(df, x = xctr, y = yctr),
                        .progress = "Getting central axis...")) |> 
    unnest(swimdir) |> 
    mutate(swimdirx = -swimdirx,
           swimdiry = -swimdiry) |> 
  
    mutate(outline = purrr::pmap(list(df = outline, x = "xctr", y = "yctr", 
                                      a = "m", b = "n",
                                      swimdirx = swimdirx, swimdiry = swimdiry),
                                 rotate_to_swimdir,
                                 .progress = "Rotating to central axis...")) |> 
    mutate(outline = purrr::map(outline, duplicate_head_tail))
}
```

```{targets even_spacing, tar_globals = TRUE}
get_even_spacing <- function(df)
{
  m.max <-
    df |> 
    ungroup() |> 
    mutate(m.max = map_vec(outline, \(df) max(df$m, na.rm = TRUE))) |> 
    summarize(m.max = median(m.max, na.rm = TRUE)) |> 
    pull(m.max)
  
  dm <- m.max / ceiling(m.max / 20)
  m.even <- seq(0, m.max, by = dm)
  
  data.frame(m.even)
}
```


```{targets merge3d}
list(
  tar_file_read(processedfiles, here(processeddatapath, "processed_bottomview_files.csv"),
                read_csv(file = !!.x) |> 
                  mutate(fileexists = map_vec(data3dfile, 
                                              \(f) file.exists(file.path(datarootpath, f))),
                         .progress = "Finding data files")),
  tar_target(testfiles, processedfiles |> 
               filter(isprocessed & fileexists) |> 
               group_by(id) |> 
               mutate(fishgroup = floor(seq(1,n()) / nfilesingroup)) |> 
               filter(id == "scup41")),
  tar_group_by(filegroup, testfiles, id, fishgroup),
  tar_target(outlinedata1,
             purrr::map_df(filegroup$data3dfile,
                    \(f) read_data_file(datarootpath, f)),
             pattern = map(filegroup),
             error = "continue"),
  tar_target(outlinedata2,
             even_outline_spacing(outlinedata1),
             pattern = map(outlinedata1),
             error = "continue"),
  tar_target(m.even, get_even_spacing(outlinedata2),
             pattern = map(outlinedata2)),
  tar_target(outlinedata,
             outlinedata2 |>
               ungroup() |> 
               unnest(outline) |>
               select(-c(xctr, yctr, point)) |>
               arrange(filename, imnum, m) |> 
               nest(edge = c(m,n)) |>
               mutate(edge.even =
                        purrr::map(edge, \(df) interp_even_side(df, m,n, m.even$m.even,
                                                                "pt", names_suffix = ''),
                                   .progress = list(name = "Interpolating even edges",
                                                    format_done = "Total time: {cli::pb_elapsed}",
                                                    clear = FALSE))) |> 
               select(-edge),
             pattern = map(outlinedata2))
)
```


# Tests

These sections will run just a few data files to make sure the pipeline above will work.

```{r eval=FALSE}
processedfiles <- here(processeddatapath, "processed_bottomview_files.csv") |> 
  read_csv() |> 
  mutate(fileexists = map_vec(data3dfile, 
                              \(f) file.exists(file.path(datarootpath, f)),
                              .progress = TRUE))
```
```{r eval=FALSE}
#testfiles <- 
  processedfiles |> 
  filter(isprocessed & fileexists) |> 
  group_by(id) #|> 
  #mutate(fishgroup = floor(seq(1,n()) / nfilesingroup))
```

```{r eval=FALSE}
filegroup <- head(testfiles, 3)

outlinedata1 <-
  purrr::map_df(filegroup$data3dfile,
                \(f) read_data_file(datarootpath, f))
```

```{r eval=FALSE}
outlinedata2 <-
  outlinedata1 |>
  even_outline_spacing()
```

```{r eval=FALSE}
m.even <- get_even_spacing(outlinedata2)
```

```{r eval=FALSE}
library(profvis)

# profvis({
outlinedata <-
  outlinedata2 |>
  ungroup() |> 
  unnest(outline) |>
  select(-c(xctr, yctr, point)) |>
  arrange(filename, imnum, m) |> 
  nest(edge = c(m, n)) |>
  # mutate(edge = purrr::map(edge, \(df) df |> arrange(m),
  #                          .progress = "Sorting coordinates")) |>
  mutate(edge.even =
           purrr::map(edge, \(df) interp_even_side(df, m, n, m.even$m.even,
                                                   "pt", names_suffix = ''),
                      .progress = "Interpolating even edges"))
# })

```


# Pipeline

```{r eval=FALSE}
tar_visnetwork()
```

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r eval=FALSE}
tar_make()
```

